const express = require("express");
const bodyParser = require("body-parser");

const port = 8086;

const conversion = require("./utils/generator/conversion");
const exploitGen = require("./utils/generator/exploit-generator");
const app = express();

app.use(bodyParser.json({ limit: "50mb" })); // for parsing application/json
app.use(
  bodyParser.urlencoded({
    limit: "50mb",
    extended: true,
    parameterLimit: 50000,
  })
); // for parsing application/x-www-form-urlencoded

Object.defineProperty(Array.prototype, "flat", {
  value: function (depth = 1) {
    return this.reduce(function (flat, toFlatten) {
      return flat.concat(
        Array.isArray(toFlatten) && depth > 1
          ? toFlatten.flat(depth - 1)
          : toFlatten
      );
    }, []);
  },
});

function trimString(string, length) {
  return string.length > length ? string.substring(0, length) + "..." : string;
}

app.post("/generate-exploit", function (req, res) {
  var requestData = req.body;

  const exploits = exploitGen.generateExploits(
    conversion.getFinding(requestData)
  );

  if (
    exploits.methodA.length +
      exploits.methodB.length +
      exploits.methodC.length !==
    0
  ) {
    console.log(
      "-> Generated Links: ",
      trimString(JSON.stringify(exploits), 80)
    );
    console.log("------------------------------------------------------------");
  }

  res.type("application/json");
  res.status(200);
  res.send(JSON.stringify(exploits));
});

app.listen(port, function () {
  console.log("------------------------------------------------------------");
  console.log("Running version 1.0.0 of exploit-generator!");
  console.log("Exploit generator running at http://127.0.0.1:" + port + "!");
  console.log("------------------------------------------------------------");
});
